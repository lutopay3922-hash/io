<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>루투페이 관리자 센터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains_Mono:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background: #0a0514; color: #eee; }
        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        .stat-card { border-left: 4px solid #a855f7; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-20">
    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center mb-10">
        <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-user-shield text-white text-xs"></i>
            </div>
            <span class="font-bold tracking-tighter text-xl">ROOTOO <span class="text-purple-500">ADMIN</span></span>
        </div>
        <div id="auth-status" class="text-xs font-bold text-white/40 flex items-center">
            <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2 animate-pulse"></span>
            CONNECTING...
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6">
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="glass p-6 rounded-3xl stat-card">
                <p class="text-white/40 text-xs font-bold uppercase mb-2">오늘의 주문</p>
                <h2 id="stat-today-orders" class="text-3xl font-black">0</h2>
            </div>
            <div class="glass p-6 rounded-3xl stat-card" style="border-left-color: #00f0ff;">
                <p class="text-white/40 text-xs font-bold uppercase mb-2">총 판매량</p>
                <h2 id="stat-total-sales" class="text-3xl font-black">0</h2>
            </div>
            <div class="glass p-6 rounded-3xl stat-card" style="border-left-color: #facc15;">
                <p class="text-white/40 text-xs font-bold uppercase mb-2">시스템 상태</p>
                <h2 class="text-3xl font-black text-green-400">ONLINE</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <!-- Order Management (2/3) -->
            <div class="lg:col-span-2 space-y-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-xl font-bold"><i class="fas fa-shopping-cart mr-3 text-purple-500"></i>실시간 주문 내역</h3>
                    <button onclick="clearOrders()" class="text-[10px] text-white/20 hover:text-red-400">내역 초기화</button>
                </div>
                <div id="order-list" class="space-y-4">
                    <div class="glass p-10 rounded-3xl text-center text-white/20 italic">주문을 불러오고 있습니다...</div>
                </div>
            </div>

            <!-- Product & Settings (1/3) -->
            <div class="space-y-10">
                <!-- Settings Control -->
                <section class="glass p-8 rounded-[32px] space-y-6">
                    <h3 class="text-lg font-bold border-b border-white/5 pb-4">상단 공지 설정</h3>
                    <div class="space-y-4">
                        <input type="text" id="input-top-notice" placeholder="상단 공지 텍스트" class="w-full p-4 bg-black/40 border border-white/10 rounded-2xl text-sm focus:outline-none focus:border-purple-500 transition-all">
                        <button onclick="updateSettings()" class="w-full py-4 bg-purple-600 rounded-2xl font-bold text-sm hover:bg-purple-500 transition-all">공지사항 즉시 적용</button>
                    </div>
                </section>

                <!-- Product Add -->
                <section class="glass p-8 rounded-[32px] space-y-6">
                    <h3 class="text-lg font-bold border-b border-white/5 pb-4">상품 추가/수정</h3>
                    <div class="space-y-4">
                        <input type="text" id="p-name" placeholder="상품명 (예: 배달의민족)" class="w-full p-4 bg-black/40 border border-white/10 rounded-2xl text-sm focus:outline-none">
                        <input type="number" id="p-price" placeholder="판매가 (숫자만)" class="w-full p-4 bg-black/40 border border-white/10 rounded-2xl text-sm focus:outline-none">
                        <input type="number" id="p-rate" placeholder="할인율 (예: 12)" class="w-full p-4 bg-black/40 border border-white/10 rounded-2xl text-sm focus:outline-none">
                        <select id="p-icon" class="w-full p-4 bg-black/40 border border-white/10 rounded-2xl text-sm focus:outline-none">
                            <option value="fas fa-utensils">식음료 (배민/쿠팡)</option>
                            <option value="fas fa-shopping-bag">쇼핑 (신세계/컬리)</option>
                            <option value="fas fa-gamepad">게임 (구글/넥슨)</option>
                            <option value="fas fa-coffee">카페 (스타벅스)</option>
                        </select>
                        <button onclick="addProduct()" class="w-full py-4 bg-emerald-600 rounded-2xl font-bold text-sm hover:bg-emerald-500 transition-all">상품 등록하기</button>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, 
            setDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 사용자께서 제공하신 Firebase Config 적용
        const firebaseConfig = {
            apiKey: "AIzaSyAiygY_0VqxYpwb6agBJzpq6pqDFzNk-eE",
            authDomain: "zcash-web-46657.firebaseapp.com",
            projectId: "zcash-web-46657",
            storageBucket: "zcash-web-46657.firebasestorage.app",
            messagingSenderId: "548237401338",
            appId: "1:548237401338:web:c060c31ec71a8dfa03bd43",
            measurementId: "G-95X3XEVX2M"
        };
        
        const appId = 'zcash-web-46657';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null;

        // 초기 인증
        onAuthStateChanged(auth, (u) => {
            user = u;
            if (user) {
                document.getElementById('auth-status').innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>DB CONNECTED`;
                initDashboard();
            } else {
                signInAnonymously(auth);
            }
        });

        function initDashboard() {
            // 1. 주문 목록 실시간 감시
            const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            onSnapshot(ordersRef, (snapshot) => {
                const list = document.getElementById('order-list');
                list.innerHTML = '';
                document.getElementById('stat-today-orders').innerText = snapshot.size;

                if (snapshot.empty) {
                    list.innerHTML = '<div class="glass p-10 rounded-3xl text-center text-white/20 italic">신규 주문이 없습니다.</div>';
                    return;
                }

                const orders = [];
                snapshot.forEach(doc => orders.push({id: doc.id, ...doc.data()}));
                orders.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                orders.forEach(order => {
                    const div = document.createElement('div');
                    div.className = "glass p-6 rounded-2xl flex flex-col md:flex-row justify-between items-start md:items-center space-y-4 md:space-y-0";
                    div.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center text-purple-400">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div>
                                <p class="text-xs text-white/40">${new Date(order.createdAt?.seconds * 1000).toLocaleString()}</p>
                                <p class="font-bold text-white">${order.customerName} <span class="text-purple-400">/ ${order.productName}</span></p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-6 w-full md:w-auto justify-between md:justify-end">
                            <p class="font-black text-lg">${Number(order.price).toLocaleString()}원</p>
                            <button onclick="deleteOrder('${order.id}')" class="px-4 py-2 bg-red-500/10 text-red-400 text-xs rounded-lg hover:bg-red-500 hover:text-white transition-all">주문삭제</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });

            // 2. 설정 실시간 감시 (판매량 등)
            const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main');
            onSnapshot(settingsRef, (snap) => {
                if(snap.exists()) {
                    document.getElementById('stat-total-sales').innerText = snap.data().totalSales || 0;
                    document.getElementById('input-top-notice').value = snap.data().topNotice || "";
                }
            });
        }

        // --- 컨트롤러 함수 ---
        window.updateSettings = async () => {
            const val = document.getElementById('input-top-notice').value;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), {
                topNotice: val
            }, { merge: true });
            alert('상단 공지가 업데이트되었습니다.');
        };

        window.addProduct = async () => {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const rate = document.getElementById('p-rate').value;
            const icon = document.getElementById('p-icon').value;

            if(!name || !price) return alert('상품명과 가격을 입력하세요.');

            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
                name, price, rate, icon, createdAt: serverTimestamp()
            });
            
            alert('상품이 성공적으로 등록되었습니다.');
            document.getElementById('p-name').value = '';
            document.getElementById('p-price').value = '';
        };

        window.deleteOrder = async (id) => {
            if(confirm('이 주문 내역을 삭제하시겠습니까?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', id));
            }
        };

        window.clearOrders = async () => {
            if(confirm('모든 주문 내역을 삭제하시겠습니까? (이 작업은 되돌릴 수 없습니다)')) {
                // 주의: 대량 삭제는 원래 반복문 처리가 필요하나, 예시를 위해 생략
                alert('개발자 모드에서 초기화가 필요합니다.');
            }
        };

    </script>
</body>
</html>
