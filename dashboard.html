<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>루투페이 관리자 센터</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700;900&family=JetBrains_Mono:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; background: #0a0514; color: #eee; }
        .glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); backdrop-filter: blur(10px); }
        .stat-card { border-left: 4px solid #a855f7; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .input-dark { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; font-size: 14px; width: 100%; outline: none; transition: border-color 0.3s; color: white; }
        .input-dark:focus { border-color: #a855f7; }
        select.input-dark option { background: #1a1525; color: white; }
        .image-preview { width: 40px; height: 40px; border-radius: 8px; object-fit: cover; background: #222; }
        
        /* Login Overlay Style */
        #login-overlay { position: fixed; inset: 0; z-index: 9999; background: #0a0514; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
        .login-card { width: 100%; max-width: 400px; padding: 40px; border-radius: 32px; border: 1px solid rgba(168, 85, 247, 0.2); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body class="min-h-screen pb-20 overflow-hidden" id="main-body">
    
    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-card glass text-center">
            <div class="w-16 h-16 bg-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-6 shadow-lg shadow-purple-500/20">
                <i class="fas fa-user-shield text-white text-2xl"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 tracking-tight">ADMIN ACCESS</h2>
            <p class="text-white/40 text-sm mb-8">관리자 계정으로 로그인하세요.</p>
            
            <div class="space-y-4 text-left">
                <div>
                    <label class="text-[10px] text-white/40 font-bold uppercase ml-1">ID</label>
                    <input type="text" id="login-id" class="input-dark mt-1" placeholder="아이디 입력">
                </div>
                <div>
                    <label class="text-[10px] text-white/40 font-bold uppercase ml-1">Password</label>
                    <input type="password" id="login-pw" class="input-dark mt-1" placeholder="비밀번호 입력">
                </div>
                <button onclick="attemptLogin()" class="w-full py-4 bg-purple-600 rounded-2xl font-bold text-sm hover:bg-purple-500 transition-all active:scale-95 shadow-lg shadow-purple-600/20 mt-4">
                    로그인 하기
                </button>
            </div>
            <p id="login-error" class="text-red-500 text-xs mt-4 font-medium opacity-0">잘못된 계정 정보입니다.</p>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="glass sticky top-0 z-50 px-6 py-4 flex justify-between items-center mb-10">
        <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-purple-600 rounded-lg flex items-center justify-center">
                <i class="fas fa-user-shield text-white text-xs"></i>
            </div>
            <span class="font-bold tracking-tighter text-xl">ROOTOO <span class="text-purple-500">ADMIN</span></span>
        </div>
        <div class="flex items-center space-x-6">
            <div id="auth-status" class="text-xs font-bold text-white/40 flex items-center">
                <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2 animate-pulse"></span>
                CONNECTING...
            </div>
            <button onclick="logout()" class="text-[10px] font-bold text-white/20 hover:text-white transition-colors uppercase tracking-widest">Logout</button>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6">
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <div class="glass p-6 rounded-3xl stat-card">
                <p class="text-white/40 text-xs font-bold uppercase mb-2">오늘의 주문</p>
                <h2 id="stat-today-orders" class="text-3xl font-black">0</h2>
            </div>
            <div class="glass p-6 rounded-3xl stat-card" style="border-left-color: #00f0ff;">
                <p class="text-white/40 text-xs font-bold uppercase mb-2">총 판매량</p>
                <h2 id="stat-total-sales" class="text-3xl font-black">0</h2>
            </div>
            <div class="glass p-6 rounded-3xl stat-card" style="border-left-color: #facc15;">
                <p class="text-white/40 text-xs font-bold uppercase mb-2">시스템 상태</p>
                <h2 class="text-3xl font-black text-green-400">ONLINE</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
            <!-- Left Column: Orders & Products List -->
            <div class="lg:col-span-2 space-y-12">
                <!-- Order Management -->
                <section class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold"><i class="fas fa-shopping-cart mr-3 text-purple-500"></i>실시간 주문 내역</h3>
                    </div>
                    <div id="order-list" class="space-y-4">
                        <div class="glass p-10 rounded-3xl text-center text-white/20 italic">주문을 불러오고 있습니다...</div>
                    </div>
                </section>

                <!-- Product Management -->
                <section class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-bold"><i class="fas fa-boxes mr-3 text-cyan-400"></i>등록된 상품 관리</h3>
                    </div>
                    <div id="product-list" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="glass p-10 rounded-3xl text-center text-white/20 italic col-span-full">상품 목록을 불러오고 있습니다...</div>
                    </div>
                </section>
            </div>

            <!-- Right Column: Settings & Controls -->
            <div class="space-y-10">
                <!-- Banner Control -->
                <section class="glass p-8 rounded-[32px] space-y-6 border-t-4 border-cyan-500">
                    <h3 class="text-lg font-bold border-b border-white/5 pb-4"><i class="fas fa-ad mr-2 text-cyan-400"></i>리미티드 배너 설정</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] text-white/40 font-bold uppercase">배경 색상</label>
                            <select id="banner-bg" class="input-dark mt-1">
                                <option value="linear-gradient(135deg, #2ac1bc 0%, #229a96 100%)">배민 민트</option>
                                <option value="linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%)">스카이 블루</option>
                                <option value="linear-gradient(135deg, #a855f7 0%, #6366f1 100%)">퍼플 인디고</option>
                                <option value="linear-gradient(135deg, #f59e0b 0%, #d97706 100%)">앰버 오렌지</option>
                                <option value="linear-gradient(135deg, #ef4444 0%, #b91c1c 100%)">로즈 레드</option>
                            </select>
                        </div>
                        <input type="text" id="banner-title" placeholder="배너 큰 제목" class="input-dark">
                        <input type="text" id="banner-rate" placeholder="할인율 (예: 12%)" class="input-dark">
                        <input type="text" id="banner-desc" placeholder="하단 상세 설명" class="input-dark">
                        <input type="text" id="banner-btn-text" placeholder="버튼 텍스트" class="input-dark">
                        <button onclick="updateBannerSettings()" class="w-full py-4 bg-cyan-600 rounded-2xl font-bold text-sm hover:bg-cyan-500 transition-all active:scale-95">설정 저장</button>
                    </div>
                </section>

                <!-- Top Notice & Sales -->
                <section class="glass p-8 rounded-[32px] space-y-6">
                    <h3 class="text-lg font-bold border-b border-white/5 pb-4"><i class="fas fa-bullhorn mr-2 text-purple-500"></i>상단 공지 & 판매량</h3>
                    <div class="space-y-4">
                        <input type="text" id="input-top-notice" placeholder="상단 공지 텍스트" class="input-dark">
                        <input type="number" id="input-total-sales" placeholder="가상 판매량 수치" class="input-dark">
                        <button onclick="updateSettings()" class="w-full py-4 bg-purple-600 rounded-2xl font-bold text-sm hover:bg-purple-500 transition-all">즉시 적용</button>
                    </div>
                </section>

                <!-- Product Add -->
                <section class="glass p-8 rounded-[32px] space-y-6">
                    <h3 class="text-lg font-bold border-b border-white/5 pb-4"><i class="fas fa-plus mr-2 text-emerald-500"></i>신규 상품 등록</h3>
                    <div class="space-y-4">
                        <input type="text" id="p-name" placeholder="상품명" class="input-dark">
                        <input type="number" id="p-price" placeholder="판매가" class="input-dark">
                        <input type="number" id="p-rate" placeholder="할인율 (%)" class="input-dark">
                        
                        <div class="space-y-2">
                            <label class="text-[10px] text-white/40 font-bold uppercase">로고 설정</label>
                            <div class="flex gap-2">
                                <select id="p-logo-type" class="input-dark w-1/3" onchange="toggleLogoInput()">
                                    <option value="icon">기본 아이콘</option>
                                    <option value="image">이미지 URL</option>
                                </select>
                                <div id="logo-icon-container" class="w-2/3">
                                    <select id="p-icon" class="input-dark">
                                        <option value="fas fa-utensils">식음료</option>
                                        <option value="fas fa-shopping-bag">쇼핑</option>
                                        <option value="fas fa-gamepad">게임</option>
                                        <option value="fas fa-coffee">카페</option>
                                        <option value="fas fa-credit-card">기타</option>
                                    </select>
                                </div>
                                <div id="logo-image-container" class="w-2/3 hidden">
                                    <input type="text" id="p-image-url" placeholder="이미지 URL (https://...)" class="input-dark">
                                </div>
                            </div>
                            <div class="mt-2">
                                <p class="text-[9px] text-white/30 mb-1">직접 업로드 (Base64 변환)</p>
                                <input type="file" id="p-image-file" accept="image/*" onchange="handleImageUpload(event)" class="text-[10px] text-white/50 file:mr-4 file:py-1 file:px-2 file:rounded-md file:border-0 file:text-[10px] file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-500">
                                <input type="hidden" id="p-image-base64">
                            </div>
                        </div>

                        <button onclick="addProduct()" class="w-full py-4 bg-emerald-600 rounded-2xl font-bold text-sm hover:bg-emerald-500 transition-all">등록하기</button>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, onSnapshot, doc, 
            setDoc, updateDoc, deleteDoc, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAiygY_0VqxYpwb6agBJzpq6pqDFzNk-eE",
            authDomain: "zcash-web-46657.firebaseapp.com",
            projectId: "zcash-web-46657",
            storageBucket: "zcash-web-46657.firebasestorage.app",
            messagingSenderId: "548237401338",
            appId: "1:548237401338:web:c060c31ec71a8dfa03bd43",
            measurementId: "G-95X3XEVX2M"
        };
        
        const appId = 'zcash-web-46657';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Authentication System ---
        const VALID_ID = "luto1004";
        const VALID_PW = "fnxn00@@";

        window.attemptLogin = () => {
            const id = document.getElementById('login-id').value;
            const pw = document.getElementById('login-pw').value;
            const errorMsg = document.getElementById('login-error');

            if (id === VALID_ID && pw === VALID_PW) {
                sessionStorage.setItem('isAdmin', 'true');
                checkAuthStatus();
            } else {
                errorMsg.style.opacity = "1";
                setTimeout(() => { errorMsg.style.opacity = "0"; }, 2000);
            }
        };

        window.logout = () => {
            sessionStorage.removeItem('isAdmin');
            location.reload();
        };

        function checkAuthStatus() {
            const isLogged = sessionStorage.getItem('isAdmin');
            if (isLogged === 'true') {
                document.getElementById('login-overlay').style.opacity = "0";
                setTimeout(() => {
                    document.getElementById('login-overlay').style.display = "none";
                    document.getElementById('main-body').classList.remove('overflow-hidden');
                }, 500);
            } else {
                document.getElementById('login-overlay').style.display = "flex";
                document.getElementById('main-body').classList.add('overflow-hidden');
            }
        }

        // 초기 실행
        checkAuthStatus();

        // 엔터키 로그인 지원
        document.getElementById('login-pw').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') attemptLogin();
        });

        // UI Helpers (전역 할당)
        window.toggleLogoInput = () => {
            const type = document.getElementById('p-logo-type').value;
            document.getElementById('logo-icon-container').classList.toggle('hidden', type !== 'icon');
            document.getElementById('logo-image-container').classList.toggle('hidden', type !== 'image');
        };

        window.handleImageUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('p-image-base64').value = e.target.result;
                document.getElementById('p-logo-type').value = 'image';
                document.getElementById('p-image-url').value = '(파일 업로드됨)';
                window.toggleLogoInput();
            };
            reader.readAsDataURL(file);
        };

        // 데이터 삭제 함수
        window.deleteOrder = async (orderId) => {
            if(!confirm('해당 주문 내역을 삭제하시겠습니까?')) return;
            try {
                const orderRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);
                await deleteDoc(orderRef);
            } catch (error) {
                console.error("Error deleting order:", error);
            }
        };

        window.deleteProduct = async (productId) => {
            if(!confirm('해당 상품을 삭제하시겠습니까?')) return;
            try {
                const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
                await deleteDoc(productRef);
            } catch (error) {
                console.error("Error deleting product:", error);
            }
        };

        window.updateSettings = async () => {
            const topNotice = document.getElementById('input-top-notice').value;
            const totalSales = parseInt(document.getElementById('input-total-sales').value) || 0;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), { topNotice, totalSales }, { merge: true });
                alert('설정이 저장되었습니다.');
            } catch (e) { alert("저장 실패"); }
        };

        window.updateBannerSettings = async () => {
            const data = {
                bannerTitle: document.getElementById('banner-title').value,
                bannerRate: document.getElementById('banner-rate').value,
                bannerDesc: document.getElementById('banner-desc').value,
                bannerBtnText: document.getElementById('banner-btn-text').value,
                bannerBg: document.getElementById('banner-bg').value
            };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), data, { merge: true });
                alert('배너 설정이 저장되었습니다.');
            } catch (e) { alert("저장 실패"); }
        };

        window.addProduct = async () => {
            const name = document.getElementById('p-name').value;
            const price = document.getElementById('p-price').value;
            const rate = document.getElementById('p-rate').value;
            const logoType = document.getElementById('p-logo-type').value;
            const icon = document.getElementById('p-icon').value;
            
            let imageUrl = document.getElementById('p-image-url').value;
            const base64 = document.getElementById('p-image-base64').value;

            if (base64) imageUrl = base64;
            if (imageUrl === '(파일 업로드됨)') imageUrl = base64;

            if(!name || !price) return alert('필수 정보를 입력하세요.');

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
                    name, 
                    price, 
                    rate, 
                    logoType,
                    icon: logoType === 'icon' ? icon : null,
                    imageUrl: logoType === 'image' ? imageUrl : null,
                    createdAt: serverTimestamp()
                });
                alert('상품이 등록되었습니다.');
                document.getElementById('p-name').value = '';
                document.getElementById('p-price').value = '';
                document.getElementById('p-image-url').value = '';
                document.getElementById('p-image-base64').value = '';
                document.getElementById('p-image-file').value = '';
            } catch (e) { alert("등록 실패"); }
        };

        onAuthStateChanged(auth, (u) => {
            if (u) {
                document.getElementById('auth-status').innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>DB CONNECTED`;
                initDashboard();
            } else {
                signInAnonymously(auth);
            }
        });

        function initDashboard() {
            // 주문 목록 실시간 감시
            const ordersRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            onSnapshot(ordersRef, (snapshot) => {
                const list = document.getElementById('order-list');
                list.innerHTML = '';
                document.getElementById('stat-today-orders').innerText = snapshot.size;
                
                if (snapshot.empty) {
                    list.innerHTML = '<div class="glass p-10 rounded-3xl text-center text-white/20 italic">신규 주문이 없습니다.</div>';
                    return;
                }

                const orders = [];
                snapshot.forEach(docSnap => orders.push({id: docSnap.id, ...docSnap.data()}));
                orders.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                orders.forEach(order => {
                    const div = document.createElement('div');
                    div.className = "glass p-6 rounded-2xl flex flex-col md:flex-row justify-between items-start md:items-center border-l-2 border-purple-500/30 gap-4";
                    div.innerHTML = `
                        <div class="flex items-center space-x-4">
                            <div class="w-10 h-10 rounded-xl bg-purple-500/20 flex items-center justify-center text-purple-400 flex-shrink-0">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="space-y-1">
                                <div class="flex items-center space-x-2">
                                    <span class="font-black text-white text-base">${order.customerName || '이름 없음'}</span>
                                    <span class="px-2 py-0.5 bg-white/5 rounded text-[10px] text-purple-400 font-bold">${order.status || '입금대기'}</span>
                                </div>
                                <p class="text-xs font-medium text-cyan-400 font-mono tracking-tighter">${order.customerPhone || '번호 없음'}</p>
                                <div class="flex items-center space-x-2 text-[10px] text-white/30">
                                    <i class="fas fa-tag"></i>
                                    <span>${order.productName}</span>
                                    <span>•</span>
                                    <span>${order.createdAt ? new Date(order.createdAt.seconds * 1000).toLocaleString() : '방금 전'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between w-full md:w-auto md:space-x-6 border-t md:border-t-0 border-white/5 pt-4 md:pt-0">
                            <div class="text-right">
                                <p class="text-[9px] text-white/40 font-bold uppercase">Payment Amount</p>
                                <p class="font-black text-lg text-white">${Number(order.price || 0).toLocaleString()}원</p>
                            </div>
                            <button onclick="window.deleteOrder('${order.id}')" class="w-10 h-10 rounded-xl bg-red-500/10 text-red-500/50 hover:bg-red-500 hover:text-white transition-all flex items-center justify-center">
                                <i class="fas fa-trash-alt text-sm"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }, (err) => console.error("Orders sync error:", err));

            // 상품 목록 실시간 감시
            const productsRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            onSnapshot(productsRef, (snapshot) => {
                const list = document.getElementById('product-list');
                list.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const p = docSnap.data();
                    const div = document.createElement('div');
                    div.className = "glass p-5 rounded-2xl flex items-center justify-between";
                    
                    let logoHtml = '';
                    if (p.logoType === 'image' && p.imageUrl) {
                        logoHtml = `<img src="${p.imageUrl}" class="image-preview" onerror="this.src='https://placehold.co/100x100?text=Error'">`;
                    } else {
                        logoHtml = `<div class="w-10 h-10 rounded-lg bg-white/5 flex items-center justify-center"><i class="${p.icon || 'fas fa-gift'} text-white/50 text-xs"></i></div>`;
                    }

                    div.innerHTML = `
                        <div class="flex items-center space-x-3">
                            ${logoHtml}
                            <div>
                                <p class="text-sm font-bold text-white">${p.name}</p>
                                <p class="text-[10px] text-purple-400">${p.rate}% 할인 | ${Number(p.price).toLocaleString()}원</p>
                            </div>
                        </div>
                        <button onclick="window.deleteProduct('${docSnap.id}')" class="text-xs font-bold text-red-500/50 hover:text-red-500 p-2">삭제</button>
                    `;
                    list.appendChild(div);
                });
            }, (err) => console.error("Products sync error:", err));

            // 설정값 실시간 감시
            const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main');
            onSnapshot(settingsRef, (snap) => {
                if(snap.exists()) {
                    const d = snap.data();
                    document.getElementById('stat-total-sales').innerText = d.totalSales || 0;
                    document.getElementById('input-total-sales').value = d.totalSales || 0;
                    document.getElementById('input-top-notice').value = d.topNotice || "";
                    document.getElementById('banner-title').value = d.bannerTitle || "";
                    document.getElementById('banner-rate').value = d.bannerRate || "";
                    document.getElementById('banner-desc').value = d.bannerDesc || "";
                    document.getElementById('banner-btn-text').value = d.bannerBtnText || "";
                    if(d.bannerBg) document.getElementById('banner-bg').value = d.bannerBg;
                }
            }, (err) => console.error("Settings sync error:", err));
        }
    </script>
</body>
</html>
